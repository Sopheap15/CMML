---
title: "<center>Central Media Making Laboratory <br> Report 2021 </center>"
output:
  html_document:
    theme: cerulean
  word_document: default
---

<!-- make leaflet center -->

```{=html}
<style>
.leaflet {
    margin: auto;
}
</style>
```
```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = F,message = F,collapse = T,warning = F,tidy = T,comment = F,fig.align = 'center')
#rm(list = ls())
```

<!-- Loading library -->

```{r loading library}
library(tidyverse)
library(lubridate)
library(rio)
library(janitor)
library(kableExtra)
library(ggrepel)
library(sf)
library(tmap)
```

<!------------------------------------ Loading data --------------------------------->

```{r loading data and bind production and delivery}
# read data from media production.......................
p_data <- read_csv("data/Media_production.csv",trim_ws = T,na = c("","NA")) %>% clean_names() %>% rename("p_quantity" = quantity)

# read data from media delivery .......................
d_data <- read_csv("data/Media_delivery.csv",trim_ws = T,na = c("","NA")) %>% clean_names() %>% rename("d_quantity" = quantity)

# Full joint data together
data <- full_join(p_data,d_data,by.x = "media_name", by.y = "media_name") %>% 
  mutate(p_month = factor(format(preparation_date,"%b"),levels = month.abb, ordered = T),
         d_month = factor(format(delivery_date,"%b"),levels = month.abb, ordered = T))


```

<!-------------------------------- Cleaning data ------------------------------------>

```{r data cleaning on production}
data <- data %>%
        mutate(powder_name = recode(media_name,
              # media bottle........
             "Blood Culture Bottle (adult)" = "BHI",
             "Blood Culture Bottle (child)" = "BHI",
              # media plate........
                               "Blood Agar" = "BAB2",
                           "Chocolate Agar" = "BAB infusion",
                           "MacConkey Agar" = "MAC",
                       "Mannitol Salt Agar" = "MSA",
                   "Mueller Hinton II Agar" = "MHII",
          "Sheep Blood Mueller-Hinton Agar" = "MHII",
                           "Ashdown's Agar" = "TSA",
"Cystine Lactose Electrolyte Deficient Agar" = "CLED",
"Thiosulfate Citrate Bile Salts Sucrose Agar" = "TCBS",
                     "Hektoen Enteric Agar" = "HEK",
              "Modified Thayer-Martin Agar" = "MTM",
            "GC agar +1% growth supplement" = "GC",
              # media tube........
                        "Kligler Iron Agar" = "KIA",
                         "Lysine Iron Agar" = "LIA",
                          "Ashdown's Broth" = "TSB",
                     "Simmons Citrate Agar" = "CIT",
           "Sulfide Indole Motility Medium" = "SIM",
                      "Trypticase Soy Agar" = "TSA",
                     "Trypticase Soy Broth" = "TSB",
      "Trypticase Soy Broth + 20% glycerol" = "TSB",
                                "Urea Agar" = "Urea"
                               ),
  # define media type............................................................
         media_type = recode(media_name,
              # media bottle........
             "Blood Culture Bottle (adult)" = "Adult Bottle",
             "Blood Culture Bottle (child)" = "Child Bottle",
              # media plate........
                               "Blood Agar" = "Plate",
                           "Chocolate Agar" = "Plate",
                           "MacConkey Agar" = "Plate",
                       "Mannitol Salt Agar" = "Plate",
                   "Mueller Hinton II Agar" = "Plate",
          "Sheep Blood Mueller-Hinton Agar" = "Plate",
                           "Ashdown's Agar" = "Plate",
"Cystine Lactose Electrolyte Deficient Agar" = "Plate",
              "Modified Thayer-Martin Agar" = "Plate",
                     "Hektoen Enteric Agar" = "Plate",
"Thiosulfate Citrate Bile Salts Sucrose Agar" = "Plate",
            "GC agar +1% growth supplement" = "Plate",
              # media tube........
                        "Kligler Iron Agar" = "Tube",
                         "Lysine Iron Agar" = "Tube",
                          "Ashdown's Broth" = "Tube",
                     "Simmons Citrate Agar" = "Tube",
           "Sulfide Indole Motility Medium" = "Tube",
                      "Trypticase Soy Agar" = "Tube",
                     "Trypticase Soy Broth" = "Tube",
      "Trypticase Soy Broth + 20% glycerol" = "Tube",
                                "Urea Agar" = "Tube"
                              ),
  # Powder calculation............................................................
              powder_kg = case_when(
               media_name == "Blood Agar" ~ p_quantity*0.88/1000,
               media_name == "Ashdown's Agar" ~ p_quantity*0.88/1000,
               media_name == "Ashdown's Broth" ~ p_quantity*0.88/1000,
               media_name == "Blood Culture Bottle (adult)" ~ (p_quantity*50*37)/1000000,
               media_name == "Blood Culture Bottle (child)" ~ (p_quantity*25*37)/1000000,
               media_name == "Chocolate Agar" ~ p_quantity*0.88/1000,
               media_name == "Cystine Lactose Electrolyte Deficient Agar" ~ p_quantity*0.8/1000,
               media_name == "CLED" ~ p_quantity*0.8/1000,
               media_name == "Hektoen Enteric Agar" ~ p_quantity*1.7/1000,
               media_name == "Kligler Iron Agar" ~ p_quantity*0.21/1000,
               media_name == "Lysine Iron Agar" ~ p_quantity*0.14/1000,
               media_name == "MacConkey Agar" ~ p_quantity*1.15/1000,
               media_name == "Mannitol Salt Agar" ~ p_quantity*2.46/1000,
               media_name == "Mueller Hinton II Agar" ~ p_quantity*0.95/1000,
               media_name == "Sheep Blood Mueller-Hinton Agar" ~ p_quantity*0.95/1000,
               media_name == "Simmons Citrate Agar" ~ p_quantity*0.07/1000,
               media_name == "Sulfide Indole Motility Medium" ~ p_quantity*0.09/1000,
               media_name == "Thiosulfate Citrate Bile Salts Sucrose Agar" ~ p_quantity*1.96/1000,
               media_name == "TCBS" ~ p_quantity*1.96/1000,
               media_name == "Trypticase Soy Agar" ~ p_quantity*0.04/1000,
               media_name == "Urea Agar" ~ p_quantity*0.07/1000, 
               media_name == "Trypticase Soy Broth" ~ p_quantity * 0.04/1000,
               media_name == "Trypticase Soy Broth + 20% glycerol" ~ p_quantity * 0.04/1000,
               media_name == "Modified Thayer-Martin Agar" ~ p_quantity * 0.88/1000,
               media_name == "GC agar +1% growth supplement" ~ p_quantity * 0.8/1000
            
                          )
  )
  
```

```{r data cleaning on delivery}
data <- data %>% 
  # recode customer name..................
  mutate(
    customer_name = recode(customer_name, 
                     "AFRIM Project BTB"  = "BTB_AFRIMS",
                     "National Public Health Laboratory Microbiology Unit"  = "NPHL",
                     "Sonua Kill Memorial Hospital" = "Sonja kill"
                     ),
# type of customer....................
customer_type = recode(customer_name,
                        #Government Lab supported by DMDP
                        "Siem Reap" = "Govt. Lab supported by DMDP",
                        "Takeo"     = "Govt. Lab supported by DMDP",
                      "Battambang"  = "Govt. Lab supported by DMDP",
                    "Kampong Cham"  = "Govt. Lab supported by DMDP",
                             "NPHL" = "Govt. Lab supported by DMDP",
                       
                        #Government lab purchase
 "Khmer Soviet Friendship Hospital" = "Govt. Lab (purchased)",
      "National Pediatric Hospital" = "Govt. Lab (purchased)",
                         "Kossamak" = "Govt. Lab (purchased)",
                       "Svay Rieng" = "Govt. Lab (purchased)",
                           
                        #Government Lab supported by project
 "Sihanouk Hospital Center of Hope" = "Govt. Lab supported by project",
                       "US NAMRU-2" = "Govt. Lab supported by project",
                       "BTB_AFRIMS" = "Govt. Lab supported by project",
"National Public Health Laboratory - AMR" = "Govt. Lab supported by project",
                           
                        # Private Lab (purchased)
                 "Sunrise Hospital" = "Private Lab (purchased)",
                         "Biobykin" = "Private Lab (purchased)",
                "Amatak Laboratory" = "Private Lab (purchased)",
       "International Standard lab" = "Private Lab (purchased)",
                              "BOM" = "Private Lab (purchased)",
       "Institute Pasteur Cambodge" = "Private Lab (purchased)",
                   "Pro Labpratory" = "Private Lab (purchased)",
"Diagnostic and Detection Laboratory" = "Private Lab (purchased)",
              "Saravorn Laboratory" = "Private Lab (purchased)",
                   "Urology clinic" = "Private Lab (purchased)",
                       "Sonja kill" = "Private Lab (purchased)",
    # "Sonua Kill Memorial Hospital" =  "Private Lab (purchased)", # incorrect name
               "Central Laboratory" = "Private Lab (purchased)",
                   "Dynamic Pharma" = "Private Lab (purchased)",
               "NHealth Laboratory" = "Private Lab (purchased)",
"American University of Phnom penh" = "Private Lab (purchased)",
              "Olympia Medical Hub" = "Private Lab (purchased)",
                        # Taiining or promotion
                    "DMDP training" = "Training/promotion",
  "Central Media Making Laboratory" = "Training/promotion",
                             "IQLS" = "Training/promotion"
                           ),

# recode media name..................
          media_name = recode(media_name, 
                  "Thiosulfate Citrate Bile Salts Sucrose Agar" = "TCBS",
                  "Cystine Lactose Electrolyte Deficient Agar"  = "CLED"),


# calculate media cost
            cost = case_when(
               media_name == "Blood Agar" ~ d_quantity * 1.1,
               media_name == "Ashdown's Agar" ~ d_quantity * 0.99,
               media_name == "Ashdown's Broth" ~ d_quantity * 0.76,
               media_name == "Blood Culture Bottle (adult)" ~ d_quantity * 1.72,
               media_name == "Blood Culture Bottle (child)" ~ d_quantity * 1.62,
               media_name == "Chocolate Agar" ~ d_quantity * 1.2,
               media_name == "Cystine Lactose Electrolyte Deficient Agar" ~ d_quantity * 0.69,
               media_name == "CLED" ~ d_quantity * 0.69,
               media_name == "Hektoen Enteric Agar" ~ d_quantity * 0.8,
               media_name == "Kligler Iron Agar" ~ d_quantity * 0.8,
               media_name == "Lysine Iron Agar" ~ d_quantity * 0.84,
               media_name == "MacConkey Agar" ~ d_quantity * 0.65,
               media_name == "Mannitol Salt Agar" ~ d_quantity * 0.88,
               media_name == "Mueller Hinton II Agar" ~ d_quantity * 0.9,
               media_name == "Sheep Blood Mueller-Hinton Agar" ~ d_quantity * 1.41,
               media_name == "Simmons Citrate Agar" ~ d_quantity * 0.76,
               media_name == "Sulfide Indole Motility Medium" ~ d_quantity * 0.83,
               media_name == "Thiosulfate Citrate Bile Salts Sucrose Agar" ~ d_quantity * 1.23,
               media_name == "TCBS" ~ d_quantity * 1.23,
               media_name == "Trypticase Soy Agar" ~ d_quantity * 0.66,
               media_name == "Urea Agar" ~ d_quantity * 1.04 
                        ## no cost for TSB, TSBG, GC, MTM
                      )
)
```

<!---------------------------------- Raw materials data ------------------------------>

```{r loading Raw materials data}
# read raw materials file
r_data <- read_csv("data/Raw_material.csv",trim_ws = T, na = c("","NA")) %>% clean_names()

# read threshold 
#threshold <- read_csv("stock_threshold.csv",trim_ws = T, na = c("","NA"))
dic <- readxl::read_excel("dictionary/dictionary.xlsx",trim_ws = T, na = c("","NA"))

r_data <- merge(r_data, dic, by = "product_name", all = T)
```

<!-------------------------------------- Cleaning Raw materials data --------------------->

```{r cleaning Raw materials data, eval= F }

# modify data...................................................
r_data <- r_data %>% 
  # filter(!product_name %in% c( "Kovacs Indole Reagent (HM)",
  #                              "Gloves Nitrile - powder free (M)",
  #                              "Gloves Nitrile - powder free (S)",
  #                              "Thiourea/HCL"
  #                              )
         
   #      ) %>% 
  mutate(
# recode product name for differentiate between inhouse product
        product_name = recode(product_name, 
                              "Crystal Violet 0.1% (In house)"   = "CrystalViolet 0.1% (In house)",
                              "Soluble Haemaglobin Powder (OX)"  = "Haemoglobin",
                              "Neutral Red 1%"                   = "NeutralRed 1%",
                              "Gloves Nitrile - powder free (M)" = "Gloves M",
                              "Gloves Nitrile - powder free (S)" = "Gloves S",
                              "Gloves Nitrile - powder free (HTC M)" = "Gloves M",
                              "Gloves Nitrile - powder free (HTC S)" = "Gloves S",
                              "THAI GLOVES(M)"                   = "Gloves M",
                              "KimCap, 13mm"                     = "KimCap 13mm"
                              
                              ),
        
        product_type = replace_na(product_type,"Other"),
        product_type = recode(product_type, 
                              "Supplement&Blood" = "Supplement",
                              "Sheep Blood" = "Supplement",
                              "Petri Dish" = "Consumables"
                              ),
        
# create new name to store understandable product name
         name = case_when(
           # dehydrate media
                grepl("Agar n1",product_name,ignore.case = T) ~ "Agar No1",
                grepl("Trypticase Soy Agar",product_name,ignore.case = T) ~ "Trypticase Soy Agar",
                grepl("Amies Transport Medium", product_name, ignore.case = T) ~ "Amie transport medium",
                #grepl("Blood Agar Base (HM)", product_name, ignore.case = T) ~ "Blood Agar Base Infusion",
                grepl("Brain Heart Infusion Broth", product_name, ignore.case = T) ~ "Brain Heart Infusion",
                grepl("CLED agar", product_name, ignore.case = T) ~ "CLED agar",
                grepl("Haemoglobin", product_name, ignore.case = T) ~ "Haemoglobin",
                grepl("Hektoen Enteric Agar", product_name, ignore.case = T) ~ "Hektoen Enteric Agar",
                grepl("Kligler Iron agar", product_name, ignore.case = T) ~ "Kligler Iron agar",
                grepl("Lysine Iron agar", product_name, ignore.case = T) ~ "Lysine Iron agar",
                grepl("MacConkey agar", product_name, ignore.case = T) ~ "MacConkey agar",
                grepl("Mannitol Salt Agar", product_name, ignore.case = T) ~ "Manitol salt agar",
                grepl("Mueller Hinton agar II", product_name, ignore.case = T) ~ "Mueller Hinton agar II",
                grepl("Mueller-Hinton Broth", product_name, ignore.case = T) ~ "Mueller Hinton broth",
                grepl("SIM Medium", product_name, ignore.case = T) ~ "SIM agar",
                grepl("Citrate Agar", product_name, ignore.case = T) ~ "Simmons citrate agar",
                grepl("Sabouraud 4% glucose agar", product_name, ignore.case = T) ~ "Sabouraud 4% glucose agar",
                grepl("Sabouraud Chloramphenicol Agar", product_name, ignore.case = T) ~ " Sabouraud Chloramphenicol Agar ",
                grepl("Sodium polyanetholesulfate", product_name, ignore.case = T) ~ "Sodium polyanethole sulfonate",
                grepl("Soyabean casein digest agar", product_name, ignore.case = T) ~ "Soyabean casein digest agar (TSA)",
                grepl("Soyabean casein digest medium", product_name, ignore.case = T) ~ "Soyabean casein digest medium (TSB)",
                grepl("Thiosulfate Citrate Bile Salts Sucrose Agar", product_name, ignore.case = T) ~ "TCBS agar",
                grepl("Tryptic Soy Blood Agar Base", product_name, ignore.case = T) ~ "Blood agar base No2",
                
                grepl("Tryptic soy broth", product_name, ignore.case = T) ~ "Tryptic soy broth",
                grepl("Urea agar", product_name, ignore.case = T) ~ "Urea agar",
                grepl("Urea supplement 40%", product_name, ignore.case = T) ~ "Urea supplement 40%",
                grepl("VCNT selective supplement", product_name, ignore.case = T) ~ "VCNT supplement",
                grepl("Vitamino Growth Supplement", product_name, ignore.case = T) ~ "Vitamino suplement",
                grepl("Vitox", product_name, ignore.case = T) ~ "Vitamino suplement",
                grepl("Sodium chloride", product_name, ignore.case = T) ~ "Sodium chloride",
                grepl("GC Agar Base", product_name, ignore.case = T) ~ "GC Agar Base",
                
                
          # Antibiotic    
                grepl("Azithromycin", product_name, ignore.case = T) ~ "Azithromycin 15mg",
                grepl("Cefixime", product_name, ignore.case = T) ~ "Cefixim 5mg",
                grepl("Ceftriaxone", product_name, ignore.case = T) ~ "Ceftriaxone 30mg",
                grepl("Ciprofloxacin", product_name, ignore.case = T) ~ "Ciprofloxacin 5mg",
                grepl("Cotrimoxazole", product_name, ignore.case = T) ~ "Cotrimoxazol 25mg",
                grepl("Sulphamethoxazole/Trimethoprim", product_name, ignore.case = T) ~ "Cotrimoxazol 25mg",
                grepl("Tetracycline", product_name, ignore.case = T) ~ "Tetracycline 30mg",
                grepl("Gentamicin 80mg", product_name, ignore.case = T) ~ "Gentamicin 80mg",
                grepl("Gentamicin CN10mg", product_name, ignore.case = T) ~ "Gentamicin 10mg",
          
            # consumable    
                grepl("Cryogenic Storage boxes", product_name,ignore.case = T)    ~ "Cryogenic storage box 100 wells",
                grepl("Sterile screw tube", product_name, ignore.case = T) ~ "Sterile crew tube 2ml",
                grepl("3M Attest Biological Indicator", product_name,ignore.case = T) ~ "Biological indicator 3M attest",
                grepl("Plugseal centrifuge tube", product_name, ignore.case = T) ~ "Conic centrifuge tube 50ml",
                grepl("BHI Cap", product_name, ignore.case = T) ~ "Cap 20mm blood bottle",
                grepl("Acetic Acid Glacial", product_name, ignore.case = T) ~ "Acetic acid",
                grepl("Airway needle", product_name, ignore.case = T) ~ "Airway needle",
                grepl("Alcohol gel", product_name, ignore.case = T) ~ "Alcohol gel",
                grepl("Alcohol Pad", product_name, ignore.case = T) ~ "Alcohol pad",
                grepl("Aluminum Foil", product_name, ignore.case = T) ~ "Aluminum foil",
                grepl("Autoclave Bag 30x60 cm", product_name, ignore.case = T) ~ "Autoclave bag 30x60",
                grepl("Autoclave bags 14L", product_name, ignore.case = T) ~ "Autoclave bags 14L",
                grepl("Triple Packaging", product_name, ignore.case = T) ~ "Triple packaging",
                grepl("Blood bag 250ml", product_name, ignore.case = T) ~ "Blood bag 250ml",
                grepl("Borosilicate Glass", product_name, ignore.case = T) ~ "Borosilicate glass tube 13x100ml",
                grepl("Buffer Solution pH 4.01", product_name, ignore.case = T) ~ "Buffer Solution pH 4.01",
                grepl("Buffer solution pH 7.00", product_name, ignore.case = T) ~ "Buffer Solution pH 7.00",
                grepl("Buffer solution pH 10.00", product_name, ignore.case = T) ~ "Buffer Solution pH 10.00",
                grepl("CHAMMATE", product_name, ignore.case = T) ~ "CHAMMAT",
                grepl("hand towel", product_name, ignore.case = T) ~ "Hand towel",
                grepl("Conductivity standard 84uS", product_name, ignore.case = T) ~ "Conductivity standard 84uS",
                grepl("Cotton Swab Sterile", product_name, ignore.case = T) ~ "Cotton swab sterile",
                grepl("Crystal Violet", product_name, ignore.case = T) ~ "Crystal Violet",
                grepl("CrystalViolet", product_name, ignore.case = T) ~ "Crystal Violet 0.1% (In house)",
                grepl("Syringe 10mml", product_name, ignore.case = T) ~ "Syringe 10cc",
                grepl("Syringe 20mml", product_name, ignore.case = T) ~ "Syringe 20cc",
                grepl("Syringe 5ml", product_name, ignore.case = T) ~ "Syringe 5cc",
                grepl("Gloves M", product_name, ignore.case = T) ~ "Gloves M - powder free",
                grepl("Gloves S", product_name, ignore.case = T) ~ "Gloves S - powder free",
                grepl("50ml Plug-seal centrifuge", product_name, ignore.case = T) ~ "50ml conic centrifuge tube",
                grepl("Glycerol", product_name, ignore.case = T) ~ "Glycerol",
                grepl("Gram Stain", product_name, ignore.case = T) ~ "Gram Stain",
                grepl("Hand Wash", product_name, ignore.case = T) ~ "Soap - hand wash",
                grepl("Hydrochloric Acid", product_name, ignore.case = T) ~ "Hydrochloric Acid",
                grepl("Needle 21G", product_name, ignore.case = T) ~ "Needle 21G",
                grepl("glass vial 100ml", product_name, ignore.case = T) ~ "Glass bottle 100ml",
                grepl("glass vial 50ml", product_name, ignore.case = T) ~ "Glass bottle 50ml",
                grepl("Loop 10.0ul", product_name, ignore.case = T) ~ "Plastic loop 10ul",
                grepl("Loop 1ul", product_name, ignore.case = T) ~ "Plastic loop 1ul",
                grepl("Junk label A3", product_name, ignore.case = T) ~ "Junk label A3",
                grepl("KCL 3 mol", product_name, ignore.case = T) ~ "Potassium chloride 3M",
                grepl("Sodium hydroxide", product_name, ignore.case = T) ~ "Sodium hydroxide",
                grepl("Kimcap 13mm", product_name, ignore.case = T) ~ "Kimcap 13mm",
                grepl("Mask", product_name, ignore.case = T) ~ "Mask",
                grepl("Microscope slides", product_name, ignore.case = T) ~ "Microscope slide",
                grepl("Neutral red", product_name, ignore.case = T) ~ "Neutral red",
                grepl("NeutralRed", product_name, ignore.case = T) ~ "Neutral red 1% (In house)",
                grepl("Petri dish", product_name, ignore.case = T) ~ "Petri dish",
                grepl("Pipette plastic 3ml sterile", product_name, ignore.case = T) ~ "Pipette plastic 3ml sterile",
                grepl("Pipette tip sterile 1000ul", product_name, ignore.case = T) ~ "Pipette tip sterile 1000ul",
                grepl("Pipette tip sterile 200ul", product_name, ignore.case = T) ~ "Pipette tip sterile 200ul",
                grepl("Rubber stopper", product_name, ignore.case = T) ~ "Rubber stopper 20mm",
                grepl("STERILIZED GAUZE", product_name, ignore.case = T) ~ "Steril gauze",
                grepl("Tape clear", product_name, ignore.case = T) ~ "Tape clear",
                
                TRUE ~ product_name
           )) 
  
  

```

### 1. Introduction

#### 1.1. Objectives

-   Demonstrate CMML activities
-   Define CMML critical needs and inform management
-   Overview of CMML raw material procurement
-   Understand customer request and organize media production as well as media delivery

--\> Data of media production, distribution and raw materials were extracted from Central Media Making Laboratory System (CMMLMS) database in comma separated value and imported to R programming language for cleaning and analysis.

#### 1.2. Background

The Diagnostic Microbiology Development Program (DMDP) has been working with the University of Health Sciences (UHS) in Phnom Penh, Cambodia since 2011 to provide a sustainable source of quality-controlled media such as blood culture broth bottles, agar plates, and media for identification of bacteriological agents. The media is produced and quality controlled by following guidelines for Assuring Quality of Medical Microbiology Culture Media; Clinical and Laboratory Standards Institute (CLSI M22) and Australian Society for Microbiology 2nd edition to guide development of CMML standard operating procedures (SOP) and processes. In 2017, DMDP supported the expansion and renovation of premises, purchase and installation of equipment and long-term on-site technical mentoring. Care and bleeding of sheep ensured access to a sustainable source of sheep blood. Since February 2019, CMML held ISO certification (ISO 9001:2015). The media products were included in the Ministry of Health Essential Medicines List (EML) and more than 20 customers purchased media for their routine clinical bacteriology laboratory set up.

<!------------------------------------Raw Materials-------------------------------------->

### 2. Raw materials

Raw materials are grouped by item name regardless of different brands to discover the current stock. Rows highlight in pink indicate that the item's quantity is lower than the threshold. The items with zero threshold were excluded from highlighting. Note: raw data might not up to date. It is depends on the day data extracted from CMMLMS

```{r Raw materials avialable in stock, results='asis'}
r_da <- r_data %>%
  filter(#remaining_stock_item_batch > 0,
         !is.na(threshold),
         !is.na(name),
         state == "Good") %>% 
  #select(remaining_stock_item_batch,name,unit,product_type) %>% 
  group_by(name, unit.y, category, threshold) %>% 
  summarise(instock = round_half_up(sum(remaining_stock_item_batch))) %>% 
  select(Category = category, 'Item name' = name, 'Qnt instock' = instock, Threshold = threshold, 'In unit' = unit.y) %>%
  arrange(Category, 'Item name')

# short order to the last row
  r_da <- rbind(r_da %>% filter(Category != "Other"),r_da %>% filter(Category == "Other"))
  
# add to table and formate
  r_da %>% 
  kable(align = c('l','l','c','c',"l"), format.args = list(big.mark = ",")) %>%
  kable_styling(bootstrap_options = c("bordered","condensed", "striped", "hover","responsive")) %>%
  row_spec(0, background = "#E09B43", color = "white", align = "c") %>% 
  row_spec(which(r_da$`Qnt instock` <= r_da$Threshold, r_da$Threshold > 0) , bold = T, background = "#FFE4E1", color = "black") %>% 
# row_spec(which(r_da$`Item name` == "Distilled Water") , background = "white",color = "black") %>% 
  #row_spec(which(r_da$`Qnt instock` <= r_da$Threshold), bold = T, background = "#DC7DED", color = "white") %>% 
  kableExtra::collapse_rows(columns = 1,valign = "top") %>% 
  scroll_box(width = "100%", height = "800px")
```

<br> Dehydrate media powder is critical for the production of culture media. Based on media production data, we express dehydrate media in grams to determine the amount of consumption.

```{r Raw material consumption base on production}
p_data <- data %>% 
  filter(preparation_date >= "2021-01-01") %>% 
  distinct(batch_number,.keep_all = T) %>% # remove duplicated..................
  group_by(powder_name) %>% 
  summarise(total = round_half_up(sum(powder_kg,na.rm = T)*1000)) 

p_data %>% 
  ggplot(aes(reorder(powder_name,-total),total,fill = powder_name)) +
  geom_bar(stat = "identity") + 
  geom_text(aes(label = format(total, big.mark = ",")), hjust = -0.1, size = 3) +
  coord_flip() +
  theme_classic() +
  theme(legend.position = "non", 
        panel.grid.major = element_blank(),
        axis.text = element_text(colour = "black"), 
        plot.title = element_text(color = "blue",face = "bold",hjust = 0.5),
        axis.title = element_text(color = "BlueViolet")) +
  scale_y_continuous(expand = c(0.01,0.01), 
                     limits = c(0,max(p_data$total) + 1000), 
                     label = scales::comma) +
  labs(y = "Quantity in gram", 
       x = "Dehydrate media", 
       title = "Dehydrate media consumption\n from media production data")

```

<!---------------------------------Sheep Care---------------------------------->

### 3. Sheep Care

Sheep blood is vital supplement to support bacteria growth and visualize hemolysis pattern. To sustain sheep blood supply for CMML, DMDP establish agreement with Resource Development International Cambodia (RDIC) and EUROVET veterinary clinics for care, feeding, bleeding and housing of the sheep.\

<center>

![Fig 1. Sheep pen](image/RDIC_sheep_pen.JPG){width="310"}  ![Fig 2. Sheep farm](image/Sheep_farm.png){width="308"}

</center>
```{r sheep, fig.width=5,fig.height=4}
sheep_rdi <- import("data/Sheep_inventory.xlsx",range = "A6:B26") %>% 
  clean_names() %>% 
  remove_empty("rows") %>% 
  mutate(farm = "RDIC",
         microchip_no = as.character(microchip_no)) 

sheep_epr <- import("data/Sheep_inventory.xlsx",range = "A31:B54") %>% 
  clean_names() %>% 
  remove_empty("rows") %>% 
  mutate(farm = "EUROVET")

sheep <- bind_rows(sheep_rdi,sheep_epr)

sheep %>% 
  filter(microchip_no != "lamb") %>% 
  group_by(farm,sex) %>% count() %>% 
  ggplot(aes(farm,n,fill = sex)) +
  geom_bar(stat = "identity") +
  geom_text(aes(label = n), position = position_stack(vjust = 0.5), size = 3) +
  labs(x = "Farm", y = "Number in head", title = "Sheep Inventory") +
  theme_classic() +
  theme(panel.grid.major = element_blank(),
        axis.text = element_text(colour = "black"), 
        plot.title = element_text(color = "blue",face = "bold",hjust = 0.5),
        plot.subtitle = element_text(color = "blue",hjust = 0.5),
        axis.title = element_text(color = "BlueViolet"))
  
```

There are **`r sheep %>% filter(microchip_no == "lamb") %>% count()`** lambs feeding and taking care at EURVET farm. It is not include in the bar chart above.   

<!------------------------------------IQC------------------------------------------------>

### 4. Media Internal Quality Control

CMML performs quality control for all batches of production media before delivery to customers. Table below summaries result of quality control of media. Note: experiment media were excluded from this table.

```{r IQC}
# import file from excel IQC.xlsx and then filter out column comment having experiment word
iqc <- import("data/IQC.xlsx") %>%
  mutate(exp = str_extract(comments,"Experiment|experiment|exper|Exper"))

iqc <- iqc %>% 
  filter(is.na(exp)) %>% 
  group_by(name_media,qc_result) %>% count() %>%
  pivot_wider(names_from = qc_result,values_from = n) %>% 
  arrange(name_media) %>%  
  adorn_totals(c("row","col")) %>% 
  mutate_all(~replace(., is.na(.), 0)) %>% 
  mutate(name_media = recode(name_media, 
                               "Cystine Lactose Electrolyte Deficient Agar" = "Cystine Lactose                                Electrolyte Deficient Agar (CLED)",
                               "Thiosulfate Citrate Bile Salts Sucrose Agar" = "Thiosulfate                                   Citrate Bile Salts Sucrose Agar (TCBS)"))

# filter column total to calculate percentage
iqc_total <- iqc %>% 
    filter(name_media == "Total") %>% 
    mutate(yes = paste(yes,"(", round(yes/Total * 100,  1) ,"%)"),
           no = paste(no,"(", round(no/Total * 100,  1) ,"%)")) 

# combine file
iqc <- iqc %>% 
filter(name_media != "Total") %>% 
  rbind(.,iqc_total) %>% 
  rename("Media name" = name_media,"Pass" = yes, "Fail" = no)

# show in table
iqc %>% 
  kable(align = c('l','c','c','c')) %>% 
  kable_styling(full_width = T, bootstrap_options = c("bordered","condensed", "striped", "hover","responsive")) %>% 
  row_spec(0,background = "#82E0AA") %>% 
  row_spec(which(iqc$Fail > 0) , bold = T, background = "#FFE4E1", color = "black")
  
  
```

<!-------------------------------Production------------------------------------>

### 5. Media production

We compute media production data from 1 Jan - `r format(max(data$preparation_date),"%d %b %Y")`

```{r cummulative media production,fig.width = 8}
p_data <- data %>% 
  filter(preparation_date >= "2021-01-01") %>% 
  distinct(batch_number,.keep_all = T) %>% # remove duplicated..................
  group_by(media_name) %>% 
  summarise(n = sum(p_quantity)) %>% arrange(-n)

ymax <- p_data %>% 
  top_n(n = 1)

p_data %>% 
  ggplot(aes(reorder(media_name, -n),n,fill = media_name)) +
  geom_bar(stat = "identity") +
  geom_text(aes(label = format(n, big.mark = ",")),size = 3, hjust = -0.01) +
  coord_flip() +
  theme_classic() +
  theme(legend.position = "non", 
        panel.grid.major = element_blank(),
        axis.text = element_text(colour = "black"), 
        plot.title = element_text(color = "blue",face = "bold",hjust = 0.5),
        plot.subtitle = element_text(color = "blue",hjust = 0.5),
        axis.title = element_text(color = "BlueViolet")) +
  scale_y_continuous(expand = c(0.01,0.01), limits = c(0, ymax$n + 1000)) +
  labs(y = "Quantity", 
       x = "Media name", 
       title = "Cummulative Media Production",
       subtitle = paste0("(n = ",format(sum(p_data$n), big.mark = ",")," unit)")) 
  
```

<!-- Media production by month-->

```{r production by month,fig.width=10, fig.height=15}
p_data <- data %>% 
  filter(preparation_date >= "2021-01-01") %>% 
  distinct(batch_number, .keep_all = T) %>% 
  group_by(media_name, p_month) %>% 
  mutate(n = sum(p_quantity)) %>% 
  select(media_name,n,p_month) %>% 
  distinct(media_name,n,p_month,.keep_all = T)

p_data %>% 
  ggplot(aes(p_month, n, fill = media_name)) +
  geom_bar(stat = "identity") +
  geom_text(aes(label = format(n,big.mark = ",")), size = 2.5, vjust = -0.2) +
  facet_wrap(~ media_name, ncol = 4) +
  theme_bw() +
  theme(strip.text = element_text(face = "bold"), 
        legend.position = "non",
        plot.title = element_text(color = "blue",face = "bold", hjust = 0.5),
        plot.subtitle = element_text(color = "blue", hjust = 0.5),
        axis.title = element_text(color = "BlueViolet")) +
  scale_y_continuous(limits = c(0,max(p_data$n) + 200)) +
  labs(x = "Month", 
       y = "Unit", 
       title = "Media Production by Month",
       subtitle = paste0("(n = ",format(sum(p_data$n), big.mark = ",")," unit)"))
```

<!-- Monthly production by month by type -->

```{r monthly production by month by type}

p_data <- data %>% 
  filter(preparation_date >= "2021-01-01") %>% 
  distinct(batch_number,media_name,media_type, .keep_all = T) %>%
  group_by(p_month, media_type) %>% 
  summarise(n = sum(p_quantity),.groups = "drop") %>%
  group_by(p_month) %>% 
  mutate(total = sum(n))

p_data %>% # plot data...........
  ggplot(aes(p_month, n, fill = media_type)) +
  geom_bar(stat = "identity" ) +
  facet_wrap(~ reorder(media_type, -n),ncol = 2) +
  geom_text(aes(label = format(n, big.mark = ",")), size = 3, vjust = -0.2) +
  theme_bw() +
  theme(strip.text = element_text(face = "bold"), 
        legend.position = "non", 
        axis.text = element_text(colour = "black"),
        plot.title = element_text(hjust = 0.5,face = "bold",colour = "blue"),
        plot.subtitle = element_text(hjust = 0.5, color = "blue"), 
        axis.title = element_text(color = "BlueViolet")) +
  scale_y_continuous(expand = c(0.01,0.01),limits = c(0,max(p_data$n) + 3000), labels = scales::comma) +
  labs(x = "Month",
       y = "Quantity", 
       title = "Media Production by Month by Type", 
       subtitle = paste0("(n = ", format(sum(p_data$n), big.mark = ",")," unit)"))  
```

In order to calculate average of media production accurately, we exclude production data of the last month with less than 28 days.

```{r , results = 'asis'}
p_data <- data %>% 
    filter(preparation_date >= "2021-01-01") %>% 
    filter(preparation_date <= ifelse(format(max(preparation_date),"%d") >= 28, max(preparation_date), as.Date(max(preparation_date)) - as.numeric(format(max(preparation_date),"%d")))) %>% # max date - max day
    distinct(batch_number,media_name,media_type, .keep_all = T) %>% 
    group_by(p_month, media_type) %>% 
    summarise(n = sum(p_quantity),.groups = "drop")
    
p_data %>% 
  group_by(media_type) %>% 
   summarise("Average (unit)" = round_half_up(mean(n)),
            "Standard Deviation" = round_half_up(sd(n))) %>% 
  rename("Media Type" = media_type) %>% 
  mutate_if(is.numeric, format, big.mark = ",") %>% 
  kable(align = c('l','c','c')) %>% 
  kable_styling(full_width = F, bootstrap_options = c("bordered","condensed", "striped", "hover","responsive")) %>% 
  column_spec(1, width = "25em") %>% 
  row_spec(0, bold = T, background = "#FFC300")

  
```

<!-------------------------------Distribution---------------------------------->

## 6. Media distribution

Media distribution is calculated from 1 Jan - `r format(max(d_data$delivery_date),"%d %b %Y")`

The bubble in the map show the different sites of customers orders and the size of the bubble indicates the quantity in units. In cooperation with interactive map, you can zoom in and click on map to see data plotting.

<!-------- adding map ------------>

```{r adding map to show customer location,fig.align='center'}
# read boundary map
map <- read_sf("khm_adm1_un/khm_adm1_un.shp")
map <- sf::st_make_valid(map)

# data
m_data <- data %>% 
          filter(!is.na(customer_name)) %>% 
          mutate(customer_name = recode(customer_name,
                      "BTB_AFRIMS" = "Battambang",
                      "National Public Health Laboratory - AMR" = "NPHL",
                      "NHealth Laboratory" = "Royal Phnom Penh hospital"
                              )) %>%
  group_by(customer_name) %>%
  summarise(Total = sum(d_quantity,na.rm = T)) 

# import coordination of customer
adr <- import("dictionary/customer_name.xlsx")

# join data and coordination
m_data <- left_join(m_data,adr) %>% 
          st_as_sf(coords = c("x","y"), crs = 4326)

tmap_mode("view")
tm_basemap("Esri.WorldTopoMap") +
tm_shape(map) +
  tm_polygons(col = "#AED6F1", alpha = 0.5) + 
  tm_shape(m_data) + 
  tm_bubbles("Total",col = "Total",legend.col.show = F) +
  tm_view(set.view = c(104.8879197, 12.6687923, 7.3)) 

```

```{r cummulative media distribution, fig.width=8}
d_data <- data %>% 
  filter(delivery_date >= "2021-01-01") %>% 
  group_by(media_name) %>% 
  summarise(n = sum(d_quantity),.groups = "drop") %>% 
  arrange(-n) 

d_data %>% 
  ggplot(aes(reorder(media_name, -n), n, fill = media_name)) +
  geom_bar(stat = "identity") +
  geom_text(aes(label = format(n, big.mark = ",")), size = 3, hjust = -0.01) +
  coord_flip() +
  theme_classic() +
  theme(legend.position = "non", 
        panel.grid.major = element_blank(), 
        axis.text = element_text(colour = "black"), 
        plot.title = element_text(color = "blue",face = "bold",hjust = 0.5),
        plot.subtitle = element_text(color = "blue",hjust = 0.5), 
        axis.title = element_text(color = "BlueViolet")) +
  scale_y_continuous(expand = c(0.01,0.01),limits = c(0,max(d_data$n) + 1000)) +
  labs(y = "Quanity", 
       x = "Media name", 
       title = "Cummulative Media Distribution", 
       subtitle = paste0("(n = ",format(sum(d_data$n,na.rm = T), big.mark = ",")," unit)")) 

```

<!-- Monthly distribution Not sure it is useful information?-->

```{r monthly distribution}
d_data <- data %>% 
  filter(delivery_date >= "2021-01-01") %>% 
  group_by(d_month, media_type) %>% 
  summarise(n = sum(d_quantity),.groups = "drop") %>%
  group_by(d_month) %>% 
  mutate(total = sum(n))

d_data %>% # plot data...........
  ggplot(aes(d_month, n, fill = media_type)) +
  geom_bar(stat = "identity", position = "dodge") +
 #facet_wrap(~ reorder(media_type,-n),ncol = 2)+
  geom_text(aes(label = format(n, big.mark = ",")),
            size = 2.5,vjust = -0.2,hjust = 0.5, 
            position = position_dodge(width = 1)) +
 scale_y_continuous(expand = c(0.01,0.01),limits = c(0,max(d_data$n) + 1250),labels = scales::comma) +
  labs(x = "Month",
       y = "Quantity",
       title = "Media Distribution by Month by Type",
       subtitle = paste0("(n =  ",format(sum(d_data$n,na.rm = T),big.mark = ",")," unit)")) +
    theme_classic() +
     theme(strip.text = element_text(face = "bold"),
        axis.text = element_text(colour = "black"),
        plot.title = element_text(color = "blue",face = "bold", hjust = 0.5),
        plot.subtitle = element_text(color = "blue",hjust = 0.5),
        axis.title = element_text(color = "BlueViolet"),
        legend.title = element_blank(),
        legend.position = c(0.7,0.9),
        legend.direction = "horizontal") 
 

```

<!-- Customer in table -->

```{r media distributes to customer, results="asis"}
d_data <- data %>% 
  filter(delivery_date >= "2021-01-01") %>% 
  select(customer_name, d_month, d_quantity, media_type) %>% 
  group_by(customer_name, d_month) %>% 
  summarise(n = sum(d_quantity), .groups = "drop") %>% 
  arrange(d_month) %>% 
  pivot_wider(names_from = d_month,values_from = n) %>% 
  mutate_all(~replace(., is.na(.), 0)) %>% 
  mutate(Total = rowSums(across(where(is.numeric)))) %>% 
  arrange(-Total) %>% 
  rename('Customer Name' = customer_name)

d_data %>% 
   mutate_if(is.numeric, format, big.mark = ",") %>% 
   kable(align = c('l','c','c','c','c','c','c','c','c','c','c','c','c')) %>% 
   kable_styling(full_width = T, bootstrap_options = c("bordered","condensed", "striped", "hover","responsive")) %>% 
  row_spec(0,background = "#CCCCFF") %>% 
  footnote(general_title = "","NPHL: National Public Health Laboratory,
               BOM: Blue Opportunity Medical Co.,Ltd.,
               NHealth Laboratory: Royal Phnom Penh hospital's laboratory")


```

<!-- Note sure it is useful but hide it now-Type of customer -->

```{r customer purchased media,fig.width = 9,fig.height=7, eval=F}
data %>% 
  filter(delivery_date >= "2021-01-01") %>%
  select(customer_type, d_month, d_quantity, media_type) %>% 
  group_by(customer_type, media_type) %>% 
  summarise(n = sum(d_quantity),.groups = "drop") %>% 
  ggplot(aes(reorder(customer_type,-n),n,fill = media_type)) +
  geom_col(position = position_stack(reverse = T)) +
  geom_text(aes(label = ifelse(n < 300,"",format(n, big.mark = ","))), size = 2.5,position =  position_stack(reverse = T, vjust = 0.5)) +
  coord_flip() +
  theme_classic() +
  theme(legend.position = "bottom",legend.title = element_blank(),axis.text = element_text(colour = "black"),plot.title = element_text(hjust = 0.5),
        plot.subtitle = element_text(hjust = 0.5),axis.title = element_text(color = "BlueViolet")) + scale_y_continuous(expand = c(0.01,0), labels = scales::comma, limits = c(0,NA)) + guides(fill = guide_legend((override.aes = c("red","purple","yellow","green")))) +
  labs(x = "",y = "Quantity",title = "TYPE OF MEDIA DISTRIBUTE to CUSTOMER") 

```

From the start of the year, CMML distributed quality controlled media to different groups of customers around the country. Customers are classified in four groups:   
1. Government laboratory supported by DMDP: Siem Reap, Battambang, Kampong Cham, Takeo and National Public Health Laboratory   
2. Government laboratory supported by project: e.g AMR surveillance, stool project in Battambang   
3. Government laboratory purchased: interestingly with an increase in orders from government laboratories e.g Khmer Soviet Friendship Hospital, Cambodia China Friendship Hospital (Kossamak), National Pediatric Hospital,...   
4. Private laboratory purchased: e.g Royal Phnom Penh hospital department of laboratory, International Laboratory, Dynamic pharma....  

```{r media distribute by customer type and media type}
d_data <- data %>% 
  filter(delivery_date >= "2021-01-01") %>% 
  select(media_type,media_name, customer_name, customer_type, d_quantity,cost) %>% 
  group_by(customer_type,media_type) %>% 
  summarise(n = sum(d_quantity,na.rm = T),.groups = "keep") %>%
  ungroup()

d_data %>% 
  ggplot(aes(factor(customer_type,levels = c("Govt. Lab supported by DMDP","Govt. Lab supported by project","Govt. Lab (purchased)","Private Lab (purchased)","Training/promotion")), n,fill = media_type)) + 
  geom_bar(stat = "identity") +
  geom_text(aes(label = format(n, big.mark = ",")), hjust = -0.1, size = 3) + 
  facet_wrap(~media_type) + 
  coord_flip() + 
  labs(x = "",
       y = "Quantity",
       title = "Media Distubution by Cusotmer Type and Media Type",
       subtitle = paste0("(n =  ",format(sum(d_data$n),big.mark = ",")," unit)")) +
  scale_y_continuous(labels = scales::comma, expand = c(0,0),limits = c(0,max(d_data$n) + 5000)) +
  theme_bw() +
  theme(legend.position = "non",
        strip.text = element_text(face = "bold"),
        axis.text = element_text(colour = "black"),
        plot.title = element_text(color = "blue",face = "bold",hjust = 0.5),
         plot.subtitle = element_text(color = "blue",hjust = 0.5))

```

<!-- distribute media base on type of customer -->

```{r proportion of media distributed to customer}
d_data <- data %>% 
  filter(delivery_date >= "2021-01-01") %>% 
  select(media_name, customer_name, customer_type, d_quantity,cost) %>% 
  group_by(customer_type) %>%
  summarise(n = sum(cost,na.rm = T),.groups = "keep") %>%
  ungroup() %>% 
  mutate(percentage = round_half_up(n/sum(n)*100))

d_data %>% 
  ggplot(aes(x = "",
             y = n, 
             fill = factor(customer_type,
                           levels = c("Govt. Lab supported by DMDP",
                                      "Govt. Lab supported by project",
                                      "Govt. Lab (purchased)",
                                      "Private Lab (purchased)",
                                      "Training/promotion")))) +
  geom_bar(stat = "identity") +
  coord_polar("y",start = 3.5, direction = -1) +
  theme_void() +
  geom_text_repel(aes(x = 1.1,label = paste0(format(round_half_up(n), big.mark = ",")," $"," (",percentage,"%)")),
                  position = position_stack(vjust = 0.5)) +
  theme(plot.title = element_text(hjust = 0.5), 
        plot.subtitle = element_text(hjust = 0.5)) + 
  labs(title = "Income from Media Distribution", 
       subtitle = paste0("Cost = (", format( round_half_up(sum(d_data$n,na.rm = T)), big.mark = ",")," USD)"),
       fill = "Customer type")
  
```

We summarised quantity and cost in USD for the DMDP supported laboratory by month for routine diagnostic.\
<!-- DMDP supported lab with type of media delivery monthly with quantity and cost -->

```{r DMDP supported lab}
d_data <- data %>% 
  select(customer_name,delivery_date,d_month,media_type,d_quantity,cost) %>% 
  filter(customer_name %in% c("Siem Reap","Battambang","Takeo","Kampong Cham","NPHL"),delivery_date >= "2021-01-01") %>% 
  group_by(d_month,customer_name,media_type) %>% 
  summarise(total = sum(d_quantity,na.rm = T),
            cost = sum(cost,na.rm = T)) %>% 
  arrange(d_month) %>% 
  mutate("Qnt (cost)" = paste(total," (", round_half_up(cost),"$)")) %>% 
  select(-total,-cost) %>% 
  pivot_wider(names_from = d_month,values_from = "Qnt (cost)") %>% 
  arrange(customer_name,media_type) %>%
  rename("Cusomter Name" = customer_name, "Media Type" = media_type ) %>% 
  mutate_all(~replace(., is.na(.), 0))

d_data %>% 
   mutate_if(is.numeric, format, big.mark = ",") %>% 
   kable(align = c('l','c','c','c','c','c','c','c','c','c','c','c','c')) %>% 
   collapse_rows(1, valign = "middle") %>% 
   kable_styling(full_width = T, bootstrap_options = c("bordered","condensed", "striped", "hover","responsive")) %>% 
  row_spec(0,background = "#C6E2FF") %>% 
  footnote(general_title = "","No price list for media: Trypticase Soy Broth, 	
Trypticase Soy Broth + 20% glycerol, Modified Thayer-Martin Agar, GC agar +1% growth supplement") 

```

<!------------------------------------Remove objects------------------------------------->

```{r remove objects}
rm(list = ls())
```

<p align="right">
Reported by CMML <br><br><br> `r format(Sys.Date(),"%d-%b-%Y")`
</p>
